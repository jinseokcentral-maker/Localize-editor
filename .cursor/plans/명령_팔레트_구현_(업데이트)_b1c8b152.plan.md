---
name: 명령 팔레트 구현 (업데이트)
overview: Excel 모드와 Vim 모드 모두에서 Cmd/Ctrl+K로 명령 팔레트를 열 수 있도록 구현. Fuzzy search로 명령 검색 지원. 자주 사용하는 명령 상단 노출. 테스트와 E2E 테스트 강화.
todos:
  - id: command-registry
    content: CommandRegistry 모듈 생성 - 명령어 타입 정의, 등록 시스템, 모드별 필터링, 기본 명령어 등록
    status: completed
  - id: fuzzy-search
    content: FuzzySearch 모듈 구현 - 검색 알고리즘 또는 라이브러리 통합, 점수 기반 정렬
    status: completed
  - id: command-palette-ui
    content: CommandPalette 컴포넌트 생성 - UI, 상태 관리, 키보드 이벤트 처리, 모드별 필터링
    status: completed
    dependencies:
      - command-registry
      - fuzzy-search
  - id: keyboard-handler-integration
    content: KeyboardHandler에 Cmd/Ctrl+K 핸들러 추가 - 모든 모드에서 작동, 현재 모드 정보 전달
    status: completed
    dependencies:
      - command-palette-ui
  - id: virtual-table-integration
    content: VirtualTableDiv에 CommandPalette 통합 및 명령 실행 메서드 구현
    status: completed
    dependencies:
      - command-palette-ui
      - keyboard-handler-integration
  - id: command-palette-styles
    content: 명령 팔레트 스타일링 (VS Code 스타일)
    status: completed
    dependencies:
      - command-palette-ui
  - id: usage-tracking
    content: 명령 사용 횟수 추적 및 자주 사용하는 명령 정렬 (localStorage)
    status: completed
    dependencies:
      - command-registry
  - id: unit-tests-registry
    content: CommandRegistry 단위 테스트 - 등록/조회, 모드별 필터링, 사용 횟수 추적
    status: completed
    dependencies:
      - command-registry
  - id: unit-tests-fuzzy
    content: FuzzySearch 단위 테스트 - 검색 알고리즘, 키워드 매칭, 정렬
    status: completed
    dependencies:
      - fuzzy-search
  - id: unit-tests-palette
    content: CommandPalette 단위 테스트 - UI 상호작용, 키보드 네비게이션, 명령 실행
    status: completed
    dependencies:
      - command-palette-ui
  - id: e2e-tests-basic
    content: E2E 테스트 - 기본 기능 (팔레트 열기/닫기, 검색, 명령 실행)
    status: completed
    dependencies:
      - virtual-table-integration
  - id: e2e-tests-commands
    content: E2E 테스트 - 명령 실행 (goto, search, filter, undo/redo)
    status: completed
    dependencies:
      - virtual-table-integration
  - id: e2e-tests-fuzzy
    content: E2E 테스트 - Fuzzy search (부분 일치, 키워드, 대소문자 무시)
    status: completed
    dependencies:
      - virtual-table-integration
  - id: e2e-tests-popular
    content: E2E 테스트 - 자주 사용하는 명령 정렬 및 표시
    status: completed
    dependencies:
      - usage-tracking
  - id: e2e-tests-keyboard
    content: E2E 테스트 - 키보드 단축키 (Cmd/Ctrl+K, 모든 브라우저)
    status: completed
    dependencies:
      - keyboard-handler-integration
  - id: e2e-tests-accessibility
    content: E2E 테스트 - 접근성 (키보드만으로 접근, 포커스 관리)
    status: completed
    dependencies:
      - command-palette-ui
---

# 명령 팔레트 (Command Palette) 구현 계획

## 목표

- Excel 모드와 Vim 모드 모두에서 Cmd/Ctrl+K로 명령 팔레트 열기
- Fuzzy search로 명령 검색
- 자주 사용하는 명령 상단 노출
- Vim 모드에서도 UI 팔레트 제공 (단축키만이 아닌)
- 확실한 테스트 및 E2E 테스트

## 아키텍처

### 컴포넌트 구조

```javascript
src/components/
  ├── command-palette.ts          # 명령 팔레트 메인 컴포넌트
  ├── command-registry.ts         # 명령어 등록 및 관리
  ├── fuzzy-search.ts             # Fuzzy search 구현 (또는 라이브러리)
  └── command-palette.css         # 스타일
```



### 데이터 흐름

```javascript
KeyboardHandler (Cmd+K 감지)
  → CommandPalette.open()
  → CommandRegistry.getCommands()
  → FuzzySearch.filter()
  → 사용자 선택
  → Command.execute()
```



## 구현 단계

### 1. CommandRegistry 생성

**파일**: `src/components/command-registry.ts`

- 명령어 타입 정의
- `id`: 고유 식별자
- `label`: 표시 이름
- `keywords`: 검색 키워드 배열
- `shortcut`: 단축키 (선택적)
- `execute`: 실행 함수
- `category`: 카테고리 (navigation, edit, filter 등)
- `usageCount`: 사용 횟수 (자주 사용하는 명령 정렬용)
- `availableInModes`: 사용 가능한 모드 (excel, vim, all)
- 명령어 등록 시스템
- `registerCommand(command)`: 명령 등록
- `getCommands(mode?)`: 모드별 명령 반환
- `getCommandById(id)`: ID로 명령 찾기
- `incrementUsage(id)`: 사용 횟수 증가
- `getPopularCommands(limit, mode?)`: 자주 사용하는 명령 반환
- 기본 명령어 등록
- `goto`: 특정 행으로 이동
- `search`: 키워드 검색
- `filter-empty`: 빈 번역만 보기
- `filter-changed`: 변경된 셀만 보기
- `filter-duplicate`: 중복 Key만 보기
- `undo`: Undo
- `redo`: Redo
- `readonly`: 읽기 전용 모드 토글
- `help`: 도움말
- `mode`: 모드 전환 (excel, vim, hybrid)

### 2. FuzzySearch 구현

**파일**: `src/components/fuzzy-search.ts`옵션 A: 직접 구현 (가벼움)

- 간단한 fuzzy match 알고리즘
- 점수 기반 정렬
- 키워드 매칭

옵션 B: 라이브러리 사용 (더 정확)

- `fuse.js` 또는 `fuzzy-search` 라이브러리
- 더 정교한 검색

**기능**:

- `search(query, commands)`: 명령어 검색
- 점수 기반 정렬
- 키워드 하이라이트

### 3. CommandPalette 컴포넌트

**파일**: `src/components/command-palette.ts`**상태 관리**:

- `isOpen`: 팔레트 열림/닫힘
- `query`: 검색 쿼리
- `filteredCommands`: 필터링된 명령 목록
- `selectedIndex`: 현재 선택된 명령 인덱스
- `currentMode`: 현재 에디터 모드 (excel, vim 등)

**UI 구조**:

```html
<div class="command-palette-overlay">
  <div class="command-palette">
    <input class="command-palette-input" />
    <div class="command-palette-list">
      <!-- 명령 목록 -->
    </div>
    <div class="command-palette-footer">
      <!-- 단축키 힌트 -->
    </div>
  </div>
</div>
```

**메서드**:

- `open(mode)`: 팔레트 열기 (모드 전달)
- `close()`: 팔레트 닫기
- `handleInput(query)`: 검색 쿼리 처리
- `handleKeyDown(e)`: 키보드 이벤트 처리
- `ArrowUp/Down`: 선택 이동
- `Enter`: 명령 실행
- `Escape`: 팔레트 닫기
- `executeCommand(command)`: 명령 실행
- `filterByMode(mode)`: 모드별 명령 필터링

**통합**:

- `VirtualTableDiv`에 통합
- 콜백을 통해 그리드 조작
- 모드 정보 전달

### 4. KeyboardHandler 확장

**파일**: `src/components/keyboard-handler.ts`**수정 사항**:

- `Cmd/Ctrl+K` 키 감지 추가
- **모든 모드에서 작동** (Excel, Vim 모두)
- `CommandPalette` 인스턴스 참조
- 팔레트 열기 콜백 추가
- 현재 모드 정보 전달
```typescript
// Cmd/Ctrl+K 감지 (모든 모드에서 작동)
if (ctrlOrCmd && (e.key === "k" || e.code === "KeyK")) {
  e.preventDefault();
  e.stopPropagation();
  if (this.callbacks.onOpenCommandPalette) {
    this.callbacks.onOpenCommandPalette(this.currentMode);
  }
  return;
}
```




### 5. VirtualTableDiv 통합

**파일**: `src/components/virtual-table-div.ts`**추가 사항**:

- `CommandPalette` 인스턴스 생성
- `CommandRegistry` 초기화 및 기본 명령 등록
- `KeyboardHandler`에 팔레트 열기 콜백 연결
- 현재 모드 상태 관리 (향후 모드 시스템 구현 시)
- 명령 실행을 위한 메서드 제공
- `gotoRow(rowIndex)`: 특정 행으로 이동
- `searchKeyword(keyword)`: 검색
- `filterEmpty()`: 빈 번역 필터
- `filterChanged()`: 변경된 셀 필터
- `filterDuplicate()`: 중복 Key 필터
- `switchMode(mode)`: 모드 전환 (향후)

### 6. 스타일링

**파일**: `src/styles/command-palette.css`**디자인**:

- VS Code 스타일 명령 팔레트
- 반투명 오버레이
- 중앙 정렬 모달
- 검색 입력 필드
- 명령 목록 (스크롤 가능)
- 선택된 항목 하이라이트
- 키보드 단축키 표시
- 모드 표시 (현재 모드 표시)

### 7. 모드별 동작

**Excel 모드**:

- `Cmd/Ctrl+K` → UI 팔레트 표시
- 마우스 클릭으로 선택 가능
- 키보드로도 선택 가능
- Excel 관련 명령만 표시 (또는 모든 명령)

**Vim 모드** (향후 구현):

- `Cmd/Ctrl+K` → UI 팔레트 표시 (동일하게)
- `:` 키 → 텍스트 입력 모드 (별도 구현, 향후)
- Vim 관련 명령도 표시
- 모든 명령 접근 가능

## 명령어 예시

### Navigation

- `goto 100`: 100번째 행으로 이동
- `goto top`: 첫 번째 행으로
- `goto bottom`: 마지막 행으로

### Search & Filter

- `search keyword`: 키워드 검색
- `filter empty`: 빈 번역만 보기
- `filter changed`: 변경된 셀만 보기
- `filter duplicate`: 중복 Key만 보기
- `clear filter`: 필터 제거

### Edit

- `undo`: Undo
- `redo`: Redo
- `readonly`: 읽기 전용 모드 토글

### Mode (향후)

- `mode excel`: Excel 모드로 전환
- `mode vim`: Vim 모드로 전환
- `mode hybrid`: 하이브리드 모드로 전환

### Help

- `help`: 도움말 표시
- `shortcuts`: 단축키 목록

## 테스트 계획 (강화)

### 단위 테스트

**파일**: `src/components/__tests__/command-registry.test.ts`

- 명령 등록/조회
- 모드별 명령 필터링
- 사용 횟수 추적
- 자주 사용하는 명령 정렬

**파일**: `src/components/__tests__/fuzzy-search.test.ts`

- 검색 알고리즘 정확도
- 키워드 매칭
- 점수 기반 정렬
- 빈 쿼리 처리
- 특수 문자 처리

**파일**: `src/components/__tests__/command-palette.test.ts`

- 팔레트 열기/닫기
- 검색 쿼리 처리
- 키보드 네비게이션 (ArrowUp/Down)
- 명령 실행
- 모드별 필터링

### E2E 테스트

**파일**: `src/tests/e2e/command-palette.spec.ts`**테스트 케이스**:

1. **기본 기능**

- `Cmd/Ctrl+K`로 팔레트 열기
- 검색 입력 및 실시간 필터링
- 키보드 네비게이션 (ArrowUp/Down)
- Enter로 명령 실행
- Escape로 팔레트 닫기

2. **명령 실행**

- `goto 100` 명령 실행 및 행 이동 확인
- `search keyword` 명령 실행 및 검색 결과 확인
- `filter empty` 명령 실행 및 필터 적용 확인
- `undo`/`redo` 명령 실행 및 상태 변경 확인

3. **모드별 동작** (향후)

- Excel 모드에서 팔레트 열기
- Vim 모드에서 팔레트 열기
- 모드별 명령 필터링 확인

4. **Fuzzy Search**

- 부분 일치 검색
- 키워드 검색
- 대소문자 무시 검색
- 특수 문자 검색

5. **자주 사용하는 명령**

- 명령 실행 후 사용 횟수 증가 확인
- 자주 사용하는 명령 상단 표시 확인
- 검색어 없을 때 인기 명령 표시

6. **키보드 단축키**

- `Cmd/Ctrl+K` (Mac/Windows)
- 모든 브라우저에서 작동 확인
- IME 입력 중에도 작동 확인

7. **접근성**

- 키보드만으로 모든 기능 접근
- 스크린 리더 호환성
- 포커스 관리

8. **에러 처리**

- 존재하지 않는 명령 실행 시
- 잘못된 파라미터 처리
- 네트워크 오류 시 (향후)

### 통합 테스트

- `VirtualTableDiv`와 `CommandPalette` 통합
- 명령 실행 후 그리드 상태 변경 확인
- 여러 명령 연속 실행

## 기술적 고려사항

### 성능

- 대량 명령어 시 가상 스크롤링 고려
- 검색 결과 제한 (최대 50개)
- Debounce 검색 입력 (300ms)
- 명령 목록 메모이제이션

### 접근성

- 키보드만으로 모든 기능 접근 가능
- 스크린 리더 지원 (ARIA 속성)
- 포커스 관리 (팔레트 열릴 때 입력 필드에 포커스)
- Escape로 팔레트 닫기

### 상태 저장

- 사용 횟수는 localStorage에 저장
- 명령 히스토리 저장 (선택적, 최근 10개)
- 모드 설정 저장

### 브라우저 호환성

- Mac: Cmd+K
- Windows/Linux: Ctrl+K
- IME 입력 중에도 작동
- 모든 주요 브라우저 테스트

## 구현 우선순위

### Phase 1: 핵심 기능

1. CommandRegistry 생성
2. FuzzySearch 구현
3. CommandPalette UI 컴포넌트
4. KeyboardHandler에 Cmd/Ctrl+K 통합
5. VirtualTableDiv 통합

### Phase 2: 테스트

6. 단위 테스트 작성
7. E2E 테스트 작성
8. 모든 브라우저에서 테스트

### Phase 3: 개선

9. 사용 횟수 추적
10. 자주 사용하는 명령 정렬
11. 성능 최적화

## 다음 단계 (향후)

- Vim 모드 `:` 명령어 통합
- 명령어 커스터마이징
- 명령어 매크로