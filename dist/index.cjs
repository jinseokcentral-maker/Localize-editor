let e=require(`effect`),t=require(`zod`);function n(e,t,n){let r=n.initialDeps??[],i,a=!0;function o(){let o;n.key&&n.debug?.()&&(o=Date.now());let s=e();if(!(s.length!==r.length||s.some((e,t)=>r[t]!==e)))return i;r=s;let c;if(n.key&&n.debug?.()&&(c=Date.now()),i=t(...s),n.key&&n.debug?.()){let e=Math.round((Date.now()-o)*100)/100,t=Math.round((Date.now()-c)*100)/100,r=t/16,i=(e,t)=>{for(e=String(e);e.length<t;)e=` `+e;return e};console.info(`%câ± ${i(t,5)} /${i(e,5)} ms`,`
            font-size: .6rem;
            font-weight: bold;
            color: hsl(${Math.max(0,Math.min(120-120*r,120))}deg 100% 31%);`,n?.key)}return n?.onChange&&!(a&&n.skipInitialOnChange)&&n.onChange(i),a=!1,i}return o.updateDeps=e=>{r=e},o}function r(e,t){if(e===void 0)throw Error(`Unexpected undefined${t?`: ${t}`:``}`);return e}const i=(e,t)=>Math.abs(e-t)<1.01,a=(e,t,n)=>{let r;return function(...i){e.clearTimeout(r),r=e.setTimeout(()=>t.apply(this,i),n)}};var o=e=>{let{offsetWidth:t,offsetHeight:n}=e;return{width:t,height:n}};const s=e=>e,c=e=>{let t=Math.max(e.startIndex-e.overscan,0),n=Math.min(e.endIndex+e.overscan,e.count-1),r=[];for(let e=t;e<=n;e++)r.push(e);return r},l=(e,t)=>{let n=e.scrollElement;if(!n)return;let r=e.targetWindow;if(!r)return;let i=e=>{let{width:n,height:r}=e;t({width:Math.round(n),height:Math.round(r)})};if(i(o(n)),!r.ResizeObserver)return()=>{};let a=new r.ResizeObserver(t=>{let r=()=>{let e=t[0];if(e?.borderBoxSize){let t=e.borderBoxSize[0];if(t){i({width:t.inlineSize,height:t.blockSize});return}}i(o(n))};e.options.useAnimationFrameWithResizeObserver?requestAnimationFrame(r):r()});return a.observe(n,{box:`border-box`}),()=>{a.unobserve(n)}};var u={passive:!0},d=typeof window>`u`?!0:`onscrollend`in window;const f=(e,t)=>{let n=e.scrollElement;if(!n)return;let r=e.targetWindow;if(!r)return;let i=0,o=e.options.useScrollendEvent&&d?()=>void 0:a(r,()=>{t(i,!1)},e.options.isScrollingResetDelay),s=r=>()=>{let{horizontal:a,isRtl:s}=e.options;i=a?n.scrollLeft*(s&&-1||1):n.scrollTop,o(),t(i,r)},c=s(!0),l=s(!1);l(),n.addEventListener(`scroll`,c,u);let f=e.options.useScrollendEvent&&d;return f&&n.addEventListener(`scrollend`,l,u),()=>{n.removeEventListener(`scroll`,c),f&&n.removeEventListener(`scrollend`,l)}},p=(e,t,n)=>{if(t?.borderBoxSize){let e=t.borderBoxSize[0];if(e)return Math.round(e[n.options.horizontal?`inlineSize`:`blockSize`])}return e[n.options.horizontal?`offsetWidth`:`offsetHeight`]},m=(e,{adjustments:t=0,behavior:n},r)=>{let i=e+t;r.scrollElement?.scrollTo?.({[r.options.horizontal?`left`:`top`]:i,behavior:n})};var h=class{unsubs=[];options;scrollElement=null;targetWindow=null;isScrolling=!1;measurementsCache=[];itemSizeCache=new Map;laneAssignments=new Map;pendingMeasuredCacheIndexes=[];prevLanes=void 0;lanesChangedFlag=!1;lanesSettling=!1;scrollRect=null;scrollOffset=null;scrollDirection=null;scrollAdjustments=0;shouldAdjustScrollPositionOnItemSizeChange;elementsCache=new Map;observer=(()=>{let e=null,t=()=>e||(!this.targetWindow||!this.targetWindow.ResizeObserver?null:e=new this.targetWindow.ResizeObserver(e=>{e.forEach(e=>{let t=()=>{this._measureElement(e.target,e)};this.options.useAnimationFrameWithResizeObserver?requestAnimationFrame(t):t()})}));return{disconnect:()=>{t()?.disconnect(),e=null},observe:e=>t()?.observe(e,{box:`border-box`}),unobserve:e=>t()?.unobserve(e)}})();range=null;constructor(e){this.setOptions(e)}setOptions=e=>{Object.entries(e).forEach(([t,n])=>{n===void 0&&delete e[t]}),this.options={debug:!1,initialOffset:0,overscan:1,paddingStart:0,paddingEnd:0,scrollPaddingStart:0,scrollPaddingEnd:0,horizontal:!1,getItemKey:s,rangeExtractor:c,onChange:()=>{},measureElement:p,initialRect:{width:0,height:0},scrollMargin:0,gap:0,indexAttribute:`data-index`,initialMeasurementsCache:[],lanes:1,isScrollingResetDelay:150,enabled:!0,isRtl:!1,useScrollendEvent:!1,useAnimationFrameWithResizeObserver:!1,...e}};notify=e=>{this.options.onChange?.(this,e)};maybeNotify=n(()=>(this.calculateRange(),[this.isScrolling,this.range?this.range.startIndex:null,this.range?this.range.endIndex:null]),e=>{this.notify(e)},{key:!1,debug:()=>this.options.debug,initialDeps:[this.isScrolling,this.range?this.range.startIndex:null,this.range?this.range.endIndex:null]});cleanup=()=>{this.unsubs.filter(Boolean).forEach(e=>e()),this.unsubs=[],this.observer.disconnect(),this.scrollElement=null,this.targetWindow=null};_didMount=()=>()=>{this.cleanup()};_willUpdate=()=>{let e=this.options.enabled?this.options.getScrollElement():null;if(this.scrollElement!==e){if(this.cleanup(),!e){this.maybeNotify();return}this.scrollElement=e,this.scrollElement&&`ownerDocument`in this.scrollElement?this.targetWindow=this.scrollElement.ownerDocument.defaultView:this.targetWindow=this.scrollElement?.window??null,this.elementsCache.forEach(e=>{this.observer.observe(e)}),this._scrollToOffset(this.getScrollOffset(),{adjustments:void 0,behavior:void 0}),this.unsubs.push(this.options.observeElementRect(this,e=>{this.scrollRect=e,this.maybeNotify()})),this.unsubs.push(this.options.observeElementOffset(this,(e,t)=>{this.scrollAdjustments=0,this.scrollDirection=t?this.getScrollOffset()<e?`forward`:`backward`:null,this.scrollOffset=e,this.isScrolling=t,this.maybeNotify()}))}};getSize=()=>this.options.enabled?(this.scrollRect=this.scrollRect??this.options.initialRect,this.scrollRect[this.options.horizontal?`width`:`height`]):(this.scrollRect=null,0);getScrollOffset=()=>this.options.enabled?(this.scrollOffset=this.scrollOffset??(typeof this.options.initialOffset==`function`?this.options.initialOffset():this.options.initialOffset),this.scrollOffset):(this.scrollOffset=null,0);getFurthestMeasurement=(e,t)=>{let n=new Map,r=new Map;for(let i=t-1;i>=0;i--){let t=e[i];if(n.has(t.lane))continue;let a=r.get(t.lane);if(a==null||t.end>a.end?r.set(t.lane,t):t.end<a.end&&n.set(t.lane,!0),n.size===this.options.lanes)break}return r.size===this.options.lanes?Array.from(r.values()).sort((e,t)=>e.end===t.end?e.index-t.index:e.end-t.end)[0]:void 0};getMeasurementOptions=n(()=>[this.options.count,this.options.paddingStart,this.options.scrollMargin,this.options.getItemKey,this.options.enabled,this.options.lanes],(e,t,n,r,i,a)=>(this.prevLanes!==void 0&&this.prevLanes!==a&&(this.lanesChangedFlag=!0),this.prevLanes=a,this.pendingMeasuredCacheIndexes=[],{count:e,paddingStart:t,scrollMargin:n,getItemKey:r,enabled:i,lanes:a}),{key:!1,skipInitialOnChange:!0,onChange:()=>{this.notify(this.isScrolling)}});getMeasurements=n(()=>[this.getMeasurementOptions(),this.itemSizeCache],({count:e,paddingStart:t,scrollMargin:n,getItemKey:r,enabled:i,lanes:a},o)=>{if(!i)return this.measurementsCache=[],this.itemSizeCache.clear(),this.laneAssignments.clear(),[];if(this.laneAssignments.size>e)for(let t of this.laneAssignments.keys())t>=e&&this.laneAssignments.delete(t);this.lanesChangedFlag&&(this.lanesChangedFlag=!1,this.lanesSettling=!0,this.measurementsCache=[],this.itemSizeCache.clear(),this.laneAssignments.clear(),this.pendingMeasuredCacheIndexes=[]),this.measurementsCache.length===0&&(this.measurementsCache=this.options.initialMeasurementsCache,this.measurementsCache.forEach(e=>{this.itemSizeCache.set(e.key,e.size)}));let s=this.lanesSettling?0:this.pendingMeasuredCacheIndexes.length>0?Math.min(...this.pendingMeasuredCacheIndexes):0;this.pendingMeasuredCacheIndexes=[],this.lanesSettling&&this.measurementsCache.length===e&&(this.lanesSettling=!1);let c=this.measurementsCache.slice(0,s),l=Array(a).fill(void 0);for(let e=0;e<s;e++){let t=c[e];t&&(l[t.lane]=e)}for(let i=s;i<e;i++){let e=r(i),a=this.laneAssignments.get(i),s,u;if(a!==void 0&&this.options.lanes>1){s=a;let e=l[s],r=e===void 0?void 0:c[e];u=r?r.end+this.options.gap:t+n}else{let e=this.options.lanes===1?c[i-1]:this.getFurthestMeasurement(c,i);u=e?e.end+this.options.gap:t+n,s=e?e.lane:i%this.options.lanes,this.options.lanes>1&&this.laneAssignments.set(i,s)}let d=o.get(e),f=typeof d==`number`?d:this.options.estimateSize(i),p=u+f;c[i]={index:i,start:u,size:f,end:p,key:e,lane:s},l[s]=i}return this.measurementsCache=c,c},{key:!1,debug:()=>this.options.debug});calculateRange=n(()=>[this.getMeasurements(),this.getSize(),this.getScrollOffset(),this.options.lanes],(e,t,n,r)=>this.range=e.length>0&&t>0?_({measurements:e,outerSize:t,scrollOffset:n,lanes:r}):null,{key:!1,debug:()=>this.options.debug});getVirtualIndexes=n(()=>{let e=null,t=null,n=this.calculateRange();return n&&(e=n.startIndex,t=n.endIndex),this.maybeNotify.updateDeps([this.isScrolling,e,t]),[this.options.rangeExtractor,this.options.overscan,this.options.count,e,t]},(e,t,n,r,i)=>r===null||i===null?[]:e({startIndex:r,endIndex:i,overscan:t,count:n}),{key:!1,debug:()=>this.options.debug});indexFromElement=e=>{let t=this.options.indexAttribute,n=e.getAttribute(t);return n?parseInt(n,10):(console.warn(`Missing attribute name '${t}={index}' on measured element.`),-1)};_measureElement=(e,t)=>{let n=this.indexFromElement(e),r=this.measurementsCache[n];if(!r)return;let i=r.key,a=this.elementsCache.get(i);a!==e&&(a&&this.observer.unobserve(a),this.observer.observe(e),this.elementsCache.set(i,e)),e.isConnected&&this.resizeItem(n,this.options.measureElement(e,t,this))};resizeItem=(e,t)=>{let n=this.measurementsCache[e];if(!n)return;let r=t-(this.itemSizeCache.get(n.key)??n.size);r!==0&&((this.shouldAdjustScrollPositionOnItemSizeChange===void 0?n.start<this.getScrollOffset()+this.scrollAdjustments:this.shouldAdjustScrollPositionOnItemSizeChange(n,r,this))&&this._scrollToOffset(this.getScrollOffset(),{adjustments:this.scrollAdjustments+=r,behavior:void 0}),this.pendingMeasuredCacheIndexes.push(n.index),this.itemSizeCache=new Map(this.itemSizeCache.set(n.key,t)),this.notify(!1))};measureElement=e=>{if(!e){this.elementsCache.forEach((e,t)=>{e.isConnected||(this.observer.unobserve(e),this.elementsCache.delete(t))});return}this._measureElement(e,void 0)};getVirtualItems=n(()=>[this.getVirtualIndexes(),this.getMeasurements()],(e,t)=>{let n=[];for(let r=0,i=e.length;r<i;r++){let i=t[e[r]];n.push(i)}return n},{key:!1,debug:()=>this.options.debug});getVirtualItemForOffset=e=>{let t=this.getMeasurements();if(t.length!==0)return r(t[g(0,t.length-1,e=>r(t[e]).start,e)])};getOffsetForAlignment=(e,t,n=0)=>{let r=this.getSize(),i=this.getScrollOffset();t===`auto`&&(t=e>=i+r?`end`:`start`),t===`center`?e+=(n-r)/2:t===`end`&&(e-=r);let a=this.getTotalSize()+this.options.scrollMargin-r;return Math.max(Math.min(a,e),0)};getOffsetForIndex=(e,t=`auto`)=>{e=Math.max(0,Math.min(e,this.options.count-1));let n=this.measurementsCache[e];if(!n)return;let r=this.getSize(),i=this.getScrollOffset();if(t===`auto`)if(n.end>=i+r-this.options.scrollPaddingEnd)t=`end`;else if(n.start<=i+this.options.scrollPaddingStart)t=`start`;else return[i,t];let a=t===`end`?n.end+this.options.scrollPaddingEnd:n.start-this.options.scrollPaddingStart;return[this.getOffsetForAlignment(a,t,n.size),t]};isDynamicMode=()=>this.elementsCache.size>0;scrollToOffset=(e,{align:t=`start`,behavior:n}={})=>{n===`smooth`&&this.isDynamicMode()&&console.warn("The `smooth` scroll behavior is not fully supported with dynamic size."),this._scrollToOffset(this.getOffsetForAlignment(e,t),{adjustments:void 0,behavior:n})};scrollToIndex=(e,{align:t=`auto`,behavior:n}={})=>{n===`smooth`&&this.isDynamicMode()&&console.warn("The `smooth` scroll behavior is not fully supported with dynamic size."),e=Math.max(0,Math.min(e,this.options.count-1));let r=0,a=t=>{if(!this.targetWindow)return;let r=this.getOffsetForIndex(e,t);if(!r){console.warn(`Failed to get offset for index:`,e);return}let[a,s]=r;this._scrollToOffset(a,{adjustments:void 0,behavior:n}),this.targetWindow.requestAnimationFrame(()=>{let t=this.getScrollOffset(),n=this.getOffsetForIndex(e,s);if(!n){console.warn(`Failed to get offset for index:`,e);return}i(n[0],t)||o(s)})},o=t=>{this.targetWindow&&(r++,r<10?this.targetWindow.requestAnimationFrame(()=>a(t)):console.warn(`Failed to scroll to index ${e} after 10 attempts.`))};a(t)};scrollBy=(e,{behavior:t}={})=>{t===`smooth`&&this.isDynamicMode()&&console.warn("The `smooth` scroll behavior is not fully supported with dynamic size."),this._scrollToOffset(this.getScrollOffset()+e,{adjustments:void 0,behavior:t})};getTotalSize=()=>{let e=this.getMeasurements(),t;if(e.length===0)t=this.options.paddingStart;else if(this.options.lanes===1)t=e[e.length-1]?.end??0;else{let n=Array(this.options.lanes).fill(null),r=e.length-1;for(;r>=0&&n.some(e=>e===null);){let t=e[r];n[t.lane]===null&&(n[t.lane]=t.end),r--}t=Math.max(...n.filter(e=>e!==null))}return Math.max(t-this.options.scrollMargin+this.options.paddingEnd,0)};_scrollToOffset=(e,{adjustments:t,behavior:n})=>{this.options.scrollToFn(e,{behavior:n,adjustments:t},this)};measure=()=>{this.itemSizeCache=new Map,this.laneAssignments=new Map,this.notify(!1)}},g=(e,t,n,r)=>{for(;e<=t;){let i=(e+t)/2|0,a=n(i);if(a<r)e=i+1;else if(a>r)t=i-1;else return i}return e>0?e-1:0};function _({measurements:e,outerSize:t,scrollOffset:n,lanes:r}){let i=e.length-1,a=t=>e[t].start;if(e.length<=r)return{startIndex:0,endIndex:i};let o=g(0,i,a,n),s=o;if(r===1)for(;s<i&&e[s].end<n+t;)s++;else if(r>1){let a=Array(r).fill(0);for(;s<i&&a.some(e=>e<n+t);){let t=e[s];a[t.lane]=t.end,s++}let c=Array(r).fill(n+t);for(;o>=0&&c.some(e=>e>=n);){let t=e[o];c[t.lane]=t.start,o--}o=Math.max(0,o-o%r),s=Math.min(i,s+(r-1-s%r))}return{startIndex:o,endIndex:s}}var v=class extends e.Data.TaggedError(`ChangeTrackerError`){},y=class extends e.Data.TaggedError(`ValidationError`){};const b=t.z.string().min(1,`Row ID must not be empty`),x=t.z.string().refine(e=>e===`key`||e===`context`||e.startsWith(`values.`),{message:`Field must be 'key', 'context', or start with 'values.'`}),S=t.z.string().min(1,`Language code must not be empty`),C=t.z.string().regex(/^.+-.+$/,`Change key must be in format 'rowId-field'`);function w(n,r,i){return e.Effect.try({try:()=>n.parse(r),catch:e=>e instanceof t.z.ZodError?new y({message:i||`Validation failed`,issues:e.issues.map(e=>({path:e.path.map(String),message:e.message}))}):new y({message:i||`Validation failed`,issues:[{path:[],message:String(e)}]})})}const T={enableValidation:!1};var E=class{config;changes=new Map;originalData=new Map;constructor(e=T){this.config={...T,...e}}initializeOriginalData(t,n){if(this.config.enableValidation){for(let t of n){let n=w(S,t,`Invalid language code: ${t}`);e.Effect.runSync(n)}for(let n of t){let t=w(b,n.id,`Invalid row ID: ${n.id}`);e.Effect.runSync(t),(typeof n.key!=`string`||n.key.length===0)&&e.Effect.runSync(e.Effect.fail(new v({message:`Invalid key for translation ${n.id}`,code:`INVALID_CHANGE_DATA`})))}}this.originalData.clear(),this.changes.clear(),t.forEach(e=>{let t=new Map;t.set(`key`,e.key),t.set(`context`,e.context||``),n.forEach(n=>{t.set(`values.${n}`,e.values[n]||``)}),this.originalData.set(e.id,t)})}getOriginalValueEffect(t,n){return e.Effect.flatMap(w(b,t,`Invalid row ID`),t=>e.Effect.flatMap(w(x,n,`Invalid field`),n=>{let r=this.originalData.get(t);if(!r)return e.Effect.fail(new v({message:`Original data not found for row ID: ${t}`,code:`ORIGINAL_DATA_NOT_FOUND`}));let i=r.get(n);return e.Effect.succeed(e.Option.fromNullable(i))}))}getOriginalValue(t,n){if(!this.config.enableValidation)return this.originalData.get(t)?.get(n)??``;let r=this.getOriginalValueEffect(t,n);return e.Effect.runSync(e.Effect.match(r,{onFailure:()=>``,onSuccess:t=>e.Option.getOrElse(t,()=>``)}))}trackChangeEffect(t,n,r,i,a,o){return e.Effect.flatMap(w(b,t,`Invalid row ID`),t=>e.Effect.flatMap(w(x,n,`Invalid field`),n=>e.Effect.flatMap(w(S,r,`Invalid language code`),r=>{if(typeof o!=`string`||o.length===0)return e.Effect.fail(new v({message:`Key must be a non-empty string`,code:`INVALID_CHANGE_DATA`}));let s=`${t}-${n}`;if(i===a)return this.changes.delete(s),e.Effect.void;let c={id:t,key:o,lang:r,oldValue:i,newValue:a};return this.changes.set(s,c),e.Effect.void})))}trackChange(t,n,r,i,a,o,s){if(!this.config.enableValidation){let e=`${t}-${n}`;if(i===a){this.changes.delete(e),s&&s(t,n,!1);return}let c={id:t,key:o,lang:r,oldValue:i,newValue:a};this.changes.set(e,c),s&&s(t,n,!0);return}let c=this.trackChangeEffect(t,n,r,i,a,o);e.Effect.runSync(e.Effect.either(c))._tag===`Right`&&s&&s(t,n,i!==a)}hasChangeEffect(t,n){return e.Effect.flatMap(w(b,t,`Invalid row ID`),t=>e.Effect.flatMap(w(x,n,`Invalid field`),n=>{let r=`${t}-${n}`;return e.Effect.succeed(this.changes.has(r))}))}hasChange(t,n){if(!this.config.enableValidation){let e=`${t}-${n}`;return this.changes.has(e)}let r=this.hasChangeEffect(t,n);return e.Effect.runSync(e.Effect.match(r,{onFailure:()=>!1,onSuccess:e=>e}))}getChanges(){return Array.from(this.changes.values())}clearChanges(e){e&&this.changes.forEach((t,n)=>{let[r,i]=n.split(`-`,2);e(r,i,!1)}),this.changes.clear()}getChangesMap(){return this.changes}},D=class{history=[];currentIndex=-1;maxHistorySize=100;push(e){this.history=this.history.slice(0,this.currentIndex+1),this.history.push(e),this.currentIndex++,this.history.length>this.maxHistorySize&&(this.history.shift(),this.currentIndex--)}canUndo(){return this.currentIndex>=0}canRedo(){return this.currentIndex<this.history.length-1}undo(){if(!this.canUndo())return null;let e=this.history[this.currentIndex];return this.currentIndex--,{type:e.type,rowId:e.rowId,columnId:e.columnId,oldValue:e.newValue,newValue:e.oldValue}}redo(){return this.canRedo()?(this.currentIndex++,this.history[this.currentIndex]):null}clear(){this.history=[],this.currentIndex=-1}getHistoryState(){return{length:this.history.length,currentIndex:this.currentIndex,canUndo:this.canUndo(),canRedo:this.canRedo()}}},O=class{metaKeyPressed=!1;ctrlKeyPressed=!1;modifierKeyDownHandler=null;modifierKeyUpHandler=null;attach(){this.modifierKeyDownHandler||this.modifierKeyUpHandler||(this.modifierKeyDownHandler=e=>{(e.key===`Meta`||e.key===`MetaLeft`||e.key===`MetaRight`)&&(this.metaKeyPressed=!0),(e.key===`Control`||e.key===`ControlLeft`||e.key===`ControlRight`)&&(this.ctrlKeyPressed=!0)},this.modifierKeyUpHandler=e=>{(e.key===`Meta`||e.key===`MetaLeft`||e.key===`MetaRight`)&&(this.metaKeyPressed=!1),(e.key===`Control`||e.key===`ControlLeft`||e.key===`ControlRight`)&&(this.ctrlKeyPressed=!1)},window.addEventListener(`keydown`,this.modifierKeyDownHandler,!0),window.addEventListener(`keyup`,this.modifierKeyUpHandler,!0))}detach(){this.modifierKeyDownHandler&&=(window.removeEventListener(`keydown`,this.modifierKeyDownHandler,!0),null),this.modifierKeyUpHandler&&=(window.removeEventListener(`keyup`,this.modifierKeyUpHandler,!0),null)}isModifierPressed(e){return navigator.platform.toUpperCase().indexOf(`MAC`)>=0?this.metaKeyPressed||e.metaKey||this.ctrlKeyPressed||e.ctrlKey:this.ctrlKeyPressed||e.ctrlKey||this.metaKeyPressed||e.metaKey}get metaKey(){return this.metaKeyPressed}get ctrlKey(){return this.ctrlKeyPressed}reset(){this.metaKeyPressed=!1,this.ctrlKeyPressed=!1}},k=class{focusedCell=null;getFocusedCell(){return this.focusedCell}focusCell(e,t){this.focusedCell={rowIndex:e,columnId:t}}blur(){this.focusedCell=null}hasFocus(){return this.focusedCell!==null}};function A(e){return e===`key`?`key`:e===`context`?`context`:e.startsWith(`values.`)?e.replace(`values.`,``):e}function j(e,t,n,r){return n===`key`?r:e.find(e=>e.id===t)?.key||``}function M(e,t,n){return e.some(e=>e.id!==t&&e.key.trim()===n.trim())}var N=class extends Error{constructor(e,t){super(e),this.code=t,this.name=`CellEditorError`}},P=class{editingCell=null;isEscapeKeyPressed=!1;isFinishingEdit=!1;constructor(e,t,n,r={}){this.translations=e,this.changeTracker=t,this.undoRedoManager=n,this.callbacks=r}getEditingCell(){return this.editingCell}isEditing(){return this.editingCell!==null}startEditingEffect(t,n,r,i){this.editingCell&&this.stopEditing();let a=i.querySelector(`.virtual-grid-cell-content`);if(!a)return e.Effect.fail(new N(`Cell content not found`,`TRANSLATION_NOT_FOUND`));let o=a.textContent||``,s=this.createEditInput(o);i.innerHTML=``,i.appendChild(s),requestAnimationFrame(()=>{s.focus(),s.select()}),this.editingCell={rowIndex:t,columnId:n,rowId:r};let c=!1;if(n===`key`){let e=()=>{let e=s.value.trim();c=!1,i.classList.remove(`cell-duplicate-key`),e&&M(this.translations,r,e)&&(c=!0,i.classList.add(`cell-duplicate-key`))};s.addEventListener(`input`,e),e()}return this.attachInputListeners(s,i,e=>{if(this.isFinishingEdit)return;this.isFinishingEdit=!0,e&&n===`key`&&c&&(e=!1),e&&s.value!==o&&this.applyCellChange(r,n,o,s.value).catch(e=>{console.error(`Failed to apply cell change:`,e)});let t=e?s.value:o;this.callbacks.updateCellContent&&this.callbacks.updateCellContent(i,r,n,t),this.editingCell=null,this.isFinishingEdit=!1},n,o,r),e.Effect.void}startEditing(e,t,n,r){this.editingCell&&this.stopEditing();let i=r.querySelector(`.virtual-grid-cell-content`);if(!i)return;let a=i.textContent||``,o=this.createEditInput(a);r.innerHTML=``,r.appendChild(o),requestAnimationFrame(()=>{o.focus(),o.select()}),this.editingCell={rowIndex:e,columnId:t,rowId:n};let s=!1;if(t===`key`){let e=()=>{let e=o.value.trim();s=!1,r.classList.remove(`cell-duplicate-key`),e&&M(this.translations,n,e)&&(s=!0,r.classList.add(`cell-duplicate-key`))};o.addEventListener(`input`,e),e()}this.attachInputListeners(o,r,e=>{if(this.isFinishingEdit)return;this.isFinishingEdit=!0,e&&t===`key`&&s&&(e=!1),e&&o.value!==a&&this.applyCellChange(n,t,a,o.value).catch(e=>{console.error(`Failed to apply cell change:`,e)});let i=e?o.value:a;this.callbacks.updateCellContent&&this.callbacks.updateCellContent(r,n,t,i),this.editingCell=null,this.isFinishingEdit=!1},t,a,n)}attachInputListeners(e,t,n,r,i,a){e.addEventListener(`blur`,()=>{this.isFinishingEdit||(this.isEscapeKeyPressed?(n(!1),this.isEscapeKeyPressed=!1):n(!0))}),e.addEventListener(`beforeinput`,e=>{(e.inputType===`historyUndo`||e.inputType===`historyRedo`)&&(e.preventDefault(),n(!0))}),e.addEventListener(`keydown`,t=>{t.key===`Enter`?(t.preventDefault(),t.stopPropagation(),n(!0),e.blur()):t.key===`Escape`?(t.preventDefault(),t.stopPropagation(),this.isEscapeKeyPressed=!0,e.blur()):t.key===`Tab`&&(t.preventDefault(),t.stopPropagation(),n(!0),e.blur())})}applyCellChangeEffect(t,n,r,i){let a=this.translations.find(e=>e.id===t);if(!a)return e.Effect.fail(new N(`Translation not found: ${t}`,`TRANSLATION_NOT_FOUND`));let o=a;if(n===`key`)o.key=i;else if(n===`context`)o.context=i;else if(n.startsWith(`values.`)){let e=n.replace(`values.`,``);o.values[e]=i}else return e.Effect.fail(new N(`Invalid column ID: ${n}`,`INVALID_COLUMN_ID`));this.undoRedoManager.push({type:`cell-change`,rowId:t,columnId:n,oldValue:r,newValue:i});let s=this.changeTracker.getOriginalValue(t,n),c=A(n),l=j(this.translations,t,n,i);return this.changeTracker.trackChange(t,n,c,s,i,l,()=>{this.callbacks.updateCellStyle&&this.callbacks.updateCellStyle(t,n)}),this.callbacks.onCellChange&&this.callbacks.onCellChange(t,n,i),e.Effect.void}async applyCellChange(t,n,r,i){let a=this.applyCellChangeEffect(t,n,r,i);return e.Effect.runPromise(a)}stopEditingEffect(t){return this.editingCell&&this.stopEditing(t),e.Effect.void}stopEditing(e){if(!this.editingCell||!e){this.editingCell=null;return}let t=e.querySelector(`[data-row-index="${this.editingCell.rowIndex}"]`);if(t){let e=t.querySelector(`[data-column-id="${this.editingCell.columnId}"]`);if(e){let t=e.querySelector(`input`);if(t){let n=e.getAttribute(`data-row-id`),r=this.editingCell.columnId,i=t.value;this.isFinishingEdit=!0,this.callbacks.updateCellContent&&n&&this.callbacks.updateCellContent(e,n,r,i),this.isFinishingEdit=!1}}}this.editingCell=null}createEditInput(e){let t=document.createElement(`input`);return t.type=`text`,t.value=e,t.className=`virtual-grid-cell-input`,t.style.width=`100%`,t.style.height=`100%`,t.style.border=`2px solid #3b82f6`,t.style.outline=`none`,t.style.padding=`4px 8px`,t.style.fontSize=`14px`,t.style.fontFamily=`inherit`,t.style.backgroundColor=`#fff`,t}setEscapeKeyPressed(e){this.isEscapeKeyPressed=e}},F=class{keyboardHandler=null;modifierKeyTracker;focusManager;constructor(e,t,n={}){this.callbacks=n,this.modifierKeyTracker=e,this.focusManager=t}attach(){this.keyboardHandler||(this.keyboardHandler=e=>{let t=this.modifierKeyTracker.isModifierPressed(e),n=e.target,r=n.tagName===`INPUT`||n.tagName===`TEXTAREA`||n.isContentEditable,i=(e.key===`z`||e.key===`Z`||e.code===`KeyZ`)&&!e.shiftKey;if(t&&i){e.preventDefault(),e.stopPropagation(),this.callbacks.onUndo&&this.callbacks.onUndo();return}let a=e.key===`y`||e.key===`Y`||e.code===`KeyY`||(e.key===`z`||e.key===`Z`||e.code===`KeyZ`)&&e.shiftKey;if(t&&a){e.preventDefault(),e.stopPropagation(),this.callbacks.onRedo&&this.callbacks.onRedo();return}this.focusManager.hasFocus()&&!r&&this.handleKeyboardNavigation(e)},document.addEventListener(`keydown`,this.keyboardHandler,!0))}detach(){this.keyboardHandler&&=(document.removeEventListener(`keydown`,this.keyboardHandler,!0),null)}handleKeyboardNavigation(e){let t=this.focusManager.getFocusedCell();if(!t||!this.callbacks.getAllColumns||!this.callbacks.focusCell)return;let{rowIndex:n,columnId:r}=t,i=this.callbacks.getAllColumns(),a=this.callbacks.getMaxRowIndex?this.callbacks.getMaxRowIndex():1/0,o=i.indexOf(r);if(o<0)return;let s=n,c=o;e.key===`Tab`&&(e.preventDefault(),e.stopPropagation(),e.shiftKey?o>0?c=o-1:n>0?(s=n-1,c=i.length-1):(s=a,c=i.length-1):o<i.length-1?c=o+1:n<a?(s=n+1,c=0):(s=0,c=0)),e.key===`Enter`&&r.startsWith(`values.`)&&(e.preventDefault(),e.stopPropagation(),e.shiftKey?n>0&&(s=n-1):n<a&&(s=n+1)),e.key.startsWith(`Arrow`)&&(e.preventDefault(),e.stopPropagation(),e.key===`ArrowRight`&&o<i.length-1?c=o+1:e.key===`ArrowLeft`&&o>0?c=o-1:e.key===`ArrowDown`&&n<a?s=n+1:e.key===`ArrowUp`&&n>0&&(s=n-1));let l=i[c];l&&(this.focusManager.focusCell(s,l),this.callbacks.focusCell(s,l),this.callbacks.onNavigate&&this.callbacks.onNavigate(s,l))}updateCallbacks(e){this.callbacks={...this.callbacks,...e}}},I=class{isResizing=!1;resizeStartX=0;resizeStartWidth=0;resizeColumnId=null;resizeHandler=null;resizeEndHandler=null;constructor(e){this.options=e}addResizeHandle(e,t){let n=document.createElement(`div`);n.className=`column-resize-handle`,n.setAttribute(`data-column-id`,t),n.style.position=`absolute`,n.style.right=`-2px`,n.style.top=`0`,n.style.bottom=`0`,n.style.width=`4px`,n.style.cursor=`col-resize`,n.style.zIndex=`25`,n.style.backgroundColor=`transparent`,n.addEventListener(`mousedown`,n=>{n.preventDefault(),n.stopPropagation(),this.startResize(t,n.clientX,e)}),e.appendChild(n)}startResize(e,t,n){this.isResizing=!0,this.resizeStartX=t,this.resizeStartWidth=n.offsetWidth||n.getBoundingClientRect().width,this.resizeColumnId=e,this.options.callbacks.onResizeStart&&this.options.callbacks.onResizeStart(e),this.resizeHandler=e=>{!this.isResizing||!this.resizeColumnId||(e.preventDefault(),this.handleResize(e.clientX))},this.resizeEndHandler=e=>{this.isResizing&&(e.preventDefault(),this.endResize())},document.addEventListener(`mousemove`,this.resizeHandler,!0),document.addEventListener(`mouseup`,this.resizeEndHandler,!0),document.body.style.cursor=`col-resize`,document.body.style.userSelect=`none`}handleResize(e){if(!this.resizeColumnId)return;let t=e-this.resizeStartX,n=this.options.columnMinWidths.get(this.resizeColumnId)||80,r=Math.max(n,this.resizeStartWidth+t),i=`values.${this.options.languages[this.options.languages.length-1]}`;this.resizeColumnId!==i&&this.options.columnWidths.set(this.resizeColumnId,r),this.options.callbacks.onResize&&this.options.callbacks.onResize(this.resizeColumnId,r)}endResize(){this.resizeHandler&&=(document.removeEventListener(`mousemove`,this.resizeHandler,!0),null),this.resizeEndHandler&&=(document.removeEventListener(`mouseup`,this.resizeEndHandler,!0),null),document.body.style.cursor=``,document.body.style.userSelect=``;let e=this.resizeColumnId,t=e&&this.options.columnWidths.get(e)||this.resizeStartWidth;this.isResizing=!1,this.resizeColumnId=null,e&&this.options.callbacks.onResizeEnd&&this.options.callbacks.onResizeEnd(e,t)}isResizingActive(){return this.isResizing}reset(){this.isResizing&&this.endResize()}},L=class{defaultKeyWidth;defaultContextWidth;defaultLangWidth;constructor(e){this.options=e,this.defaultKeyWidth=e.defaultKeyWidth??200,this.defaultContextWidth=e.defaultContextWidth??200,this.defaultLangWidth=e.defaultLangWidth??150}getColumnWidthValue(e,t){return this.options.columnWidths.get(e)||t||this.getDefaultWidth(e)}getDefaultWidth(e){return e===`key`?this.defaultKeyWidth:e===`context`?this.defaultContextWidth:this.defaultLangWidth}calculateColumnWidths(e){let t=this.getColumnWidthValue(`key`,this.defaultKeyWidth),n=this.getColumnWidthValue(`context`,this.defaultContextWidth),r=this.options.languages.map(e=>this.getColumnWidthValue(`values.${e}`,this.defaultLangWidth)),i=t+n+r.slice(0,-1).reduce((e,t)=>e+t,0),a=this.options.languages[this.options.languages.length-1],o=this.options.columnMinWidths.get(`values.${a}`)||80,s=Math.max(o,e-i);return{key:t,context:n,languages:[...r.slice(0,-1),s]}}applyColumnWidth(e,t,n){let r=`values.${this.options.languages[this.options.languages.length-1]}`;e!==r&&this.options.columnWidths.set(e,t);let i=e===`key`?t:this.getColumnWidthValue(`key`,this.defaultKeyWidth),a=e===`context`?t:this.getColumnWidthValue(`context`,this.defaultContextWidth),o=this.options.languages.slice(0,-1).map(n=>{let r=`values.${n}`;return e===r?t:this.getColumnWidthValue(r,this.defaultLangWidth)}),s=i+a+o.reduce((e,t)=>e+t,0),c=this.options.columnMinWidths.get(r)||80,l=Math.max(c,n-s);return{columnWidths:{key:i,context:a,languages:[...o,l]},totalWidth:n}}},R=class{constructor(e){this.options=e}createHeaderCell(e,t,n,r,i){let a=document.createElement(`div`);return a.className=`virtual-grid-header-cell`,a.setAttribute(`role`,`columnheader`),a.textContent=e,i&&a.setAttribute(`data-column-id`,i),a.style.width=`${t}px`,a.style.minWidth=`${t}px`,a.style.maxWidth=`${t}px`,(n>0||r>0)&&(a.style.position=`sticky`,a.style.left=`${n}px`,a.style.zIndex=r.toString(),a.style.backgroundColor=`#f8fafc`),a.style.overflow=`visible`,a}createRow(e,t,n){let r=document.createElement(`div`);r.className=`virtual-grid-row`,r.setAttribute(`role`,`row`),r.setAttribute(`data-row-index`,t.toString()),r.setAttribute(`data-row-id`,e.id);let i=this.createCell(e.id,`key`,e.key,t,!0,n.key,0,10);r.appendChild(i);let a=this.createCell(e.id,`context`,e.context||``,t,!0,n.context,n.key,10);return r.appendChild(a),this.options.languages.forEach((i,a)=>{let o=e.values[i]||``,s=n.languages[a],c=this.createCell(e.id,`values.${i}`,o,t,!this.options.readOnly,s,0,0);r.appendChild(c)}),r}createCell(e,t,n,r,i,a,o,s){let c=document.createElement(`div`);c.className=`virtual-grid-cell`,c.setAttribute(`role`,`gridcell`),c.setAttribute(`data-row-id`,e),c.setAttribute(`data-column-id`,t),c.setAttribute(`data-row-index`,r.toString()),c.setAttribute(`tabindex`,i?`0`:`-1`),c.style.width=`${a}px`,c.style.minWidth=`${a}px`,c.style.maxWidth=`${a}px`,(o>0||s>0)&&(c.style.position=`sticky`,c.style.left=`${o}px`,c.style.zIndex=s.toString(),c.style.backgroundColor=`#fafafa`);let l=document.createElement(`div`);return l.className=`virtual-grid-cell-content`,l.textContent=n,c.appendChild(l),this.options.callbacks.updateCellStyle&&this.options.callbacks.updateCellStyle(e,t,c),i&&!this.options.readOnly&&(c.addEventListener(`dblclick`,e=>{e.preventDefault(),e.stopPropagation(),this.options.callbacks.onCellDblClick&&this.options.callbacks.onCellDblClick(r,t,c)}),c.addEventListener(`focus`,()=>{this.options.callbacks.onCellFocus&&this.options.callbacks.onCellFocus(r,t),c.classList.add(`focused`)}),c.addEventListener(`blur`,()=>{c.classList.remove(`focused`)})),c}updateCellContent(e,t,n,r,i){e.innerHTML=``;let a=document.createElement(`div`);a.className=`virtual-grid-cell-content`,a.textContent=r,e.appendChild(a),!this.options.readOnly&&this.options.editableColumns.has(n)&&e.addEventListener(`dblclick`,t=>{t.preventDefault(),t.stopPropagation(),this.options.callbacks.onCellDblClick&&this.options.callbacks.onCellDblClick(i,n,e)}),this.options.callbacks.updateCellStyle&&this.options.callbacks.updateCellStyle(t,n,e)}},z=class{container;scrollElement=null;gridElement=null;headerElement=null;bodyElement=null;options;rowVirtualizer=null;virtualizerCleanup=null;renderScheduled=!1;resizeObserver=null;columnWidths=new Map;editableColumns=new Set;rowHeight=40;headerHeight=40;changeTracker=new E;undoRedoManager=new D;modifierKeyTracker=new O;focusManager=new k;cellEditor;keyboardHandlerModule;columnResizer;columnWidthCalculator;gridRenderer;columnMinWidths=new Map;constructor(e){this.container=e.container,this.options=e,this.columnWidths=e.columnWidths||new Map,this.rowHeight=e.rowHeight||40,this.headerHeight=e.headerHeight||40,this.editableColumns=new Set([`key`,`context`]),e.languages.forEach(e=>{this.editableColumns.add(`values.${e}`)}),this.columnMinWidths.set(`key`,100),this.columnMinWidths.set(`context`,100),e.languages.forEach(e=>{this.columnMinWidths.set(`values.${e}`,80)}),this.changeTracker.initializeOriginalData(e.translations,e.languages),this.cellEditor=new P(e.translations,this.changeTracker,this.undoRedoManager,{onCellChange:e.onCellChange,updateCellStyle:(e,t)=>{this.updateCellStyle(e,t)},updateCellContent:(e,t,n,r)=>{let i=e.getAttribute(`data-row-index`),a=i?parseInt(i,10):0;this.gridRenderer.updateCellContent(e,t,n,r,a)}}),this.keyboardHandlerModule=new F(this.modifierKeyTracker,this.focusManager,{onUndo:()=>this.handleUndo(),onRedo:()=>this.handleRedo(),getAllColumns:()=>[`key`,`context`,...e.languages.map(e=>`values.${e}`)],getMaxRowIndex:()=>e.translations.length-1,focusCell:(e,t)=>{this.focusCell(e,t)}}),this.columnWidthCalculator=new L({columnWidths:this.columnWidths,columnMinWidths:this.columnMinWidths,languages:e.languages}),this.columnResizer=new I({columnWidths:this.columnWidths,columnMinWidths:this.columnMinWidths,languages:e.languages,callbacks:{onResize:(e,t)=>{this.applyColumnWidth(e,t)},onResizeEnd:()=>{this.rowVirtualizer&&this.bodyElement&&this.renderVirtualRows()}}}),this.gridRenderer=new R({languages:e.languages,readOnly:e.readOnly,editableColumns:this.editableColumns,callbacks:{onCellDblClick:(e,t,n)=>{this.startEditing(e,t,n)},onCellFocus:(e,t)=>{this.focusManager.focusCell(e,t)},updateCellStyle:(e,t,n)=>{this.updateCellStyle(e,t,n)}}})}render(){this.scrollElement&&this.container.contains(this.scrollElement)&&this.container.removeChild(this.scrollElement),this.scrollElement=document.createElement(`div`),this.scrollElement.className=`virtual-grid-scroll-container`,this.scrollElement.style.width=`100%`,this.scrollElement.style.height=`100%`,this.scrollElement.style.overflow=`auto`,this.scrollElement.style.position=`relative`,this.gridElement=document.createElement(`div`),this.gridElement.className=`virtual-grid`,this.gridElement.setAttribute(`role`,`grid`),this.options.readOnly&&this.gridElement.classList.add(`readonly`),this.headerElement=document.createElement(`div`),this.headerElement.className=`virtual-grid-header`,this.renderHeader(),this.gridElement.appendChild(this.headerElement),this.bodyElement=document.createElement(`div`),this.bodyElement.className=`virtual-grid-body`,this.bodyElement.style.position=`relative`,this.gridElement.appendChild(this.bodyElement),this.scrollElement.appendChild(this.gridElement),this.container.appendChild(this.scrollElement),this.observeContainerResize(),requestAnimationFrame(()=>{this.initVirtualScrolling()}),this.attachKeyboardListeners()}observeContainerResize(){this.resizeObserver&&this.resizeObserver.disconnect(),typeof ResizeObserver<`u`&&(this.resizeObserver=new ResizeObserver(()=>{this.headerElement&&(this.headerElement.innerHTML=``,this.renderHeader()),this.rowVirtualizer&&this.renderVirtualRows()}),this.resizeObserver.observe(this.container))}initVirtualScrolling(){if(!this.scrollElement||!this.bodyElement){console.error(`VirtualTableDiv: scrollElement or bodyElement is null`);return}let e=(()=>{if(this.scrollElement){let e=this.scrollElement.getBoundingClientRect();if(e.width>0&&e.height>0)return{width:e.width,height:e.height}}return{width:this.container.clientWidth||800,height:this.container.clientHeight||600}})();this.rowVirtualizer=new h({count:this.options.translations.length,getScrollElement:()=>this.scrollElement,estimateSize:()=>this.rowHeight,scrollToFn:m,observeElementRect:l,observeElementOffset:f,initialRect:e,onChange:()=>{this.renderScheduled||(this.renderScheduled=!0,requestAnimationFrame(()=>{this.renderScheduled=!1,this.renderVirtualRows()}))}}),this.rowVirtualizer._willUpdate(),this.virtualizerCleanup=this.rowVirtualizer._didMount(),requestAnimationFrame(()=>{this.renderVirtualRows()})}renderVirtualRows(){if(!this.rowVirtualizer||!this.bodyElement)return;let e=null,t=this.cellEditor.getEditingCell();if(t){let n=this.bodyElement.querySelector(`[data-row-index="${t.rowIndex}"]`);if(n){let r=n.querySelector(`[data-column-id="${t.columnId}"]`);if(r){let n=r.querySelector(`input`);n&&(e={rowId:t.rowId,columnId:t.columnId,value:n.value})}}}this.bodyElement.innerHTML=``;let n=this.rowVirtualizer.getVirtualItems(),r=this.rowVirtualizer.getTotalSize();this.bodyElement.style.height=`${r}px`;let i,a=this.getContainerWidth();if(this.columnResizer.isResizingActive())i=this.columnWidthCalculator.calculateColumnWidths(a);else if(this.columnWidths.size>0)i=this.columnWidthCalculator.calculateColumnWidths(a);else{let e=this.getColumnWidthsFromHeader();if(e){let t=e.key+e.context+e.languages.slice(0,-1).reduce((e,t)=>e+t,0),n=this.columnMinWidths.get(`values.${this.options.languages[this.options.languages.length-1]}`)||80,r=Math.max(n,a-t);i={key:e.key,context:e.context,languages:[...e.languages.slice(0,-1),r]}}else i=this.columnWidthCalculator.calculateColumnWidths(a)}n.forEach(t=>{let n=this.options.translations[t.index];if(!n)return;let r=this.gridRenderer.createRow(n,t.index,i),o=a;if(r.style.position=`absolute`,r.style.top=`${t.start}px`,r.style.left=`0`,r.style.width=`${o}px`,r.style.minWidth=`${o}px`,r.style.maxWidth=`${o}px`,r.style.height=`${t.size}px`,r.setAttribute(`data-index`,t.index.toString()),this.bodyElement.appendChild(r),e&&n.id===e.rowId){let n=r.querySelector(`[data-column-id="${e.columnId}"]`);n&&requestAnimationFrame(()=>{this.startEditing(t.index,e.columnId,n);let r=n.querySelector(`input`);r&&(r.value=e.value,r.focus(),r.select())})}this.rowVirtualizer.measureElement(r)})}renderHeader(){if(!this.headerElement)return;let e=document.createElement(`div`);e.className=`virtual-grid-header-row`,e.setAttribute(`role`,`row`);let t=this.getContainerWidth(),n;this.columnWidths.size>0?n=this.columnWidthCalculator.calculateColumnWidths(t):(n=this.columnWidthCalculator.calculateColumnWidths(t),this.columnWidths.set(`key`,n.key),this.columnWidths.set(`context`,n.context),this.options.languages.slice(0,-1).forEach((e,t)=>{let r=n.languages[t];this.columnWidths.set(`values.${e}`,r)}));let r=t;e.style.width=`${r}px`,e.style.minWidth=`${r}px`,e.style.maxWidth=`${r}px`;let i=this.gridRenderer.createHeaderCell(`Key`,n.key,0,10,`key`);this.columnResizer.addResizeHandle(i,`key`),e.appendChild(i);let a=this.gridRenderer.createHeaderCell(`Context`,n.context,n.key,10,`context`);this.columnResizer.addResizeHandle(a,`context`),e.appendChild(a),this.options.languages.forEach((t,r)=>{let i=n.languages[r],a=`values.${t}`,o=this.gridRenderer.createHeaderCell(t.toUpperCase(),i,0,0,a);this.columnResizer.addResizeHandle(o,a),e.appendChild(o)}),this.headerElement.appendChild(e)}applyColumnWidth(e,t){let n=this.getContainerWidth(),{columnWidths:r,totalWidth:i}=this.columnWidthCalculator.applyColumnWidth(e,t,n);if(this.headerElement){let e=this.headerElement.querySelector(`.virtual-grid-header-row`);e&&(e.style.width=`${i}px`,e.style.minWidth=`${i}px`,e.style.maxWidth=`${i}px`);let t=this.headerElement.querySelector(`[data-column-id="key"]`);t&&(t.style.width=`${r.key}px`,t.style.minWidth=`${r.key}px`,t.style.maxWidth=`${r.key}px`);let n=this.headerElement.querySelector(`[data-column-id="context"]`);n&&(n.style.width=`${r.context}px`,n.style.minWidth=`${r.context}px`,n.style.maxWidth=`${r.context}px`,n.style.left=`${r.key}px`),this.options.languages.forEach((e,t)=>{let n=this.headerElement.querySelector(`[data-column-id="values.${e}"]`);if(n){let e=r.languages[t];n.style.width=`${e}px`,n.style.minWidth=`${e}px`,n.style.maxWidth=`${e}px`}})}this.bodyElement&&(this.bodyElement.querySelectorAll(`.virtual-grid-row`).forEach(e=>{let t=e;t.style.width=`${i}px`,t.style.minWidth=`${i}px`,t.style.maxWidth=`${i}px`}),this.bodyElement.querySelectorAll(`[data-column-id="key"]`).forEach(e=>{let t=e;t.style.width=`${r.key}px`,t.style.minWidth=`${r.key}px`,t.style.maxWidth=`${r.key}px`}),this.bodyElement.querySelectorAll(`[data-column-id="context"]`).forEach(e=>{let t=e;t.style.width=`${r.context}px`,t.style.minWidth=`${r.context}px`,t.style.maxWidth=`${r.context}px`,t.style.left=`${r.key}px`}),this.options.languages.forEach((e,t)=>{let n=this.bodyElement.querySelectorAll(`[data-column-id="values.${e}"]`),i=r.languages[t];n.forEach(e=>{let t=e;t.style.width=`${i}px`,t.style.minWidth=`${i}px`,t.style.maxWidth=`${i}px`})}))}getColumnWidthsFromHeader(){if(!this.headerElement)return null;let e=this.headerElement.querySelector(`.virtual-grid-header-row`);if(!e)return null;let t=e.querySelectorAll(`.virtual-grid-header-cell`),n={key:0,context:0,languages:[]};return t.forEach(e=>{let t=e.getAttribute(`data-column-id`),r=e.offsetWidth||e.getBoundingClientRect().width;t===`key`?n.key=r:t===`context`?n.context=r:t&&t.startsWith(`values.`)&&n.languages.push(r)}),n.key>0&&n.context>0&&n.languages.length===this.options.languages.length?n:null}startEditing(e,t,n){let r=n.getAttribute(`data-row-id`);r&&this.cellEditor.startEditing(e,t,r,n)}stopEditing(){this.cellEditor.stopEditing(this.bodyElement||void 0)}updateCellStyle(e,t,n){if(!this.bodyElement)return;let r=n||this.bodyElement.querySelector(`[data-row-id="${e}"][data-column-id="${t}"]`);if(!r)return;let i=`${e}-${t}`;if(this.changeTracker.getChangesMap().has(i)?r.classList.add(`cell-dirty`):r.classList.remove(`cell-dirty`),t.startsWith(`values.`)){let n=this.options.translations.find(t=>t.id===e);if(n){let e=t.replace(`values.`,``),i=n.values[e]||``;!i||typeof i==`string`&&i.trim()===``?r.classList.add(`cell-empty`):r.classList.remove(`cell-empty`)}}}attachKeyboardListeners(){this.modifierKeyTracker.attach(),this.keyboardHandlerModule.attach()}focusCell(e,t){if(!this.bodyElement)return;let n=this.bodyElement.querySelector(`[data-row-index="${e}"][data-column-id="${t}"]`);n&&(n.focus(),this.focusManager.focusCell(e,t))}handleUndo(){if(!this.undoRedoManager.canUndo()){console.log(`VirtualTableDiv: Cannot undo - no history`);return}let e=this.undoRedoManager.undo();if(!e){console.log(`VirtualTableDiv: Undo returned null`);return}this.applyUndoRedoAction(e)}handleRedo(){if(!this.undoRedoManager.canRedo()){console.log(`VirtualTableDiv: Cannot redo - no future history`);return}let e=this.undoRedoManager.redo();if(!e){console.log(`VirtualTableDiv: Redo returned null`);return}this.applyUndoRedoAction(e)}applyUndoRedoAction(e){if(e.type!==`cell-change`){console.log(`VirtualTableDiv: Invalid action type`,e.type);return}this.cellEditor.isEditing()&&this.stopEditing();let t=this.options.translations.find(t=>t.id===e.rowId);if(!t){console.error(`VirtualTableDiv: Translation not found`,e.rowId);return}let n=t;if(e.columnId===`key`)n.key=e.newValue;else if(e.columnId===`context`)n.context=e.newValue;else if(e.columnId.startsWith(`values.`)){let t=e.columnId.replace(`values.`,``);n.values[t]=e.newValue}else{console.error(`VirtualTableDiv: Invalid columnId`,e.columnId);return}let r=this.bodyElement?.querySelector(`[data-row-id="${e.rowId}"][data-column-id="${e.columnId}"]`);if(r){let t=r.getAttribute(`data-row-index`),n=t?parseInt(t,10):0;this.gridRenderer.updateCellContent(r,e.rowId,e.columnId,e.newValue,n)}else this.updateCellStyle(e.rowId,e.columnId);let i=this.changeTracker.getOriginalValue(e.rowId,e.columnId),a=A(e.columnId),o=j(this.options.translations,e.rowId,e.columnId,e.newValue);this.changeTracker.trackChange(e.rowId,e.columnId,a,i,e.newValue,o,()=>{this.updateCellStyle(e.rowId,e.columnId)}),this.options.onCellChange&&this.options.onCellChange(e.rowId,e.columnId,e.newValue),this.rowVirtualizer&&this.bodyElement&&this.renderVirtualRows()}getContainerWidth(){return this.container&&this.container.clientWidth>0?this.container.clientWidth:typeof window<`u`?window.innerWidth:1e3}setReadOnly(e){this.options={...this.options,readOnly:e},this.gridElement&&(e?this.gridElement.classList.add(`readonly`):this.gridElement.classList.remove(`readonly`)),this.bodyElement&&this.bodyElement.querySelectorAll(`.virtual-grid-cell`).forEach(t=>{let n=t.getAttribute(`data-column-id`),r=n&&this.editableColumns.has(n);t.setAttribute(`tabindex`,r&&!e?`0`:`-1`)})}getChanges(){return this.changeTracker.getChanges()}clearChanges(){this.changeTracker.clearChanges((e,t)=>{this.updateCellStyle(e,t)})}destroy(){this.keyboardHandlerModule&&this.keyboardHandlerModule.detach(),this.modifierKeyTracker&&this.modifierKeyTracker.detach(),this.resizeObserver&&=(this.resizeObserver.disconnect(),null),this.virtualizerCleanup&&=(this.virtualizerCleanup(),null),this.scrollElement&&this.container.contains(this.scrollElement)&&this.container.removeChild(this.scrollElement),this.scrollElement=null,this.gridElement=null,this.headerElement=null,this.bodyElement=null,this.rowVirtualizer=null}};exports.ChangeTracker=E,exports.VirtualTableDiv=z;