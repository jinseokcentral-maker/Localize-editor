#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "üß™ Running tests before push (concurrent)..."
echo ""

# Get the repository root directory
REPO_ROOT="$(git rev-parse --show-toplevel)"
cd "$REPO_ROOT" || exit 1

# Create temporary files for exit codes and logs
UNIT_EXIT_FILE="/tmp/unit-exit-$$.tmp"
E2E_EXIT_FILE="/tmp/e2e-exit-$$.tmp"
UNIT_LOG="/tmp/unit-test-$$.log"
E2E_LOG="/tmp/e2e-test-$$.log"

# ANSI color codes
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
RED='\033[0;31m'
RESET='\033[0m'

# Function to prefix output with colored [Unit] or [E2E]
prefix_output() {
  local prefix="$1"
  local color="$2"
  while IFS= read -r line; do
    echo "${color}[$prefix]${RESET} $line"
  done
}

# Run unit and E2E tests concurrently
echo "üì¶ Starting unit and E2E tests..."
echo ""

# Unit test with blue prefixed output
(
  pnpm test --run > "$UNIT_LOG" 2>&1
  TEST_EXIT=$?
  prefix_output "Unit" "$BLUE" < "$UNIT_LOG"
  echo $TEST_EXIT > "$UNIT_EXIT_FILE"
) &
UNIT_PID=$!

# E2E test with yellow prefixed output
(
  CI=true TEST_PORT=3002 pnpm exec playwright test --reporter=list > "$E2E_LOG" 2>&1
  TEST_EXIT=$?
  prefix_output "E2E" "$YELLOW" < "$E2E_LOG"
  echo $TEST_EXIT > "$E2E_EXIT_FILE"
) &
E2E_PID=$!

# Wait for both tests to complete
wait $UNIT_PID
wait $E2E_PID

# Read exit codes from files
UNIT_EXIT=$(cat "$UNIT_EXIT_FILE" 2>/dev/null || echo "1")
E2E_EXIT=$(cat "$E2E_EXIT_FILE" 2>/dev/null || echo "1")

# Cleanup temporary files
rm -f "$UNIT_EXIT_FILE" "$E2E_EXIT_FILE" "$UNIT_LOG" "$E2E_LOG"

# Check results
FAILED=false

if [ "$UNIT_EXIT" -ne 0 ]; then
  echo ""
  echo "‚ùå Unit tests failed (exit code: $UNIT_EXIT)"
  FAILED=true
fi

if [ "$E2E_EXIT" -ne 0 ]; then
  echo ""
  echo "‚ùå E2E tests failed (exit code: $E2E_EXIT)"
  FAILED=true
fi

if [ "$FAILED" = true ]; then
  echo ""
  echo "‚ùå Some tests failed. Push aborted."
  exit 1
fi

echo ""
echo "‚úÖ All tests passed! Pushing..."
exit 0

